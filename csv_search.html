<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CSV Search</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        input[type="file"],
        input[type="text"],
        button {
            margin-bottom: 10px;
            font-size: 15px;
        }

        input[type="text"] {
            width: 100%;
            padding: 8px;
        }

        button {
            padding: 6px 12px;
            cursor: pointer;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            border: none;
            padding: 6px 8px;
            text-align: left;
            vertical-align: top;
        }

        th {
            background: #eee;
            font-weight: bold;
        }

        .error {
            color: #b00020;
            font-weight: bold;
            margin-top: 10px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>

<h2>CSV Search</h2>

<input type="file" id="fileInput" accept=".csv">

<input
    id="search"
    type="text"
    placeholder="Search keywordsâ€¦ (use --term to exclude)"
    disabled
>

<button id="download" disabled>
    Download current results as CSV
</button>

<p id="error" class="error hidden"></p>

<table id="table" class="hidden">
    <thead></thead>
    <tbody></tbody>
</table>

<script>
(function () {
    var BASE_URL = "https://pbvppkf0kuzw4c6s.public.blob.vercel-storage.com/";
    var sourceFilename = "results.csv";

    var headers = [];
    var rows = [];
    var currentRows = [];

    var fileInput = document.getElementById("fileInput");
    var searchInput = document.getElementById("search");
    var downloadBtn = document.getElementById("download");
    var table = document.getElementById("table");
    var thead = table.querySelector("thead");
    var tbody = table.querySelector("tbody");
    var errorEl = document.getElementById("error");

    function showError(msg) {
        errorEl.textContent = msg;
        errorEl.className = "error";
        searchInput.disabled = true;
        downloadBtn.disabled = true;
    }

    function clearError() {
        errorEl.textContent = "";
        errorEl.className = "error hidden";
    }

    function getParam(name) {
        var params = window.location.search.substring(1).split("&");
        for (var i = 0; i < params.length; i++) {
            var pair = params[i].split("=");
            if (decodeURIComponent(pair[0]) === name) {
                return decodeURIComponent(pair[1] || "");
            }
        }
        return null;
    }

    function sanitizeText(text) {
        return text
            .replace(/^\uFEFF/, "")
            .replace(/\u0000/g, "")
            .replace(/[\u0001-\u0008]/g, "")
            .replace(/[\u000B-\u001F]/g, "")
            .replace(/\u007F/g, "")
            .replace(/\uFFFD/g, "");
    }

    function parseCSV(text) {
        text = sanitizeText(text);

        var data = [];
        var row = [];
        var cell = "";
        var inQuotes = false;

        for (var i = 0; i < text.length; i++) {
            var c = text[i];
            var next = text[i + 1];

            if (c === '"') {
                if (inQuotes && next === '"') {
                    cell += '"';
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (c === ',' && !inQuotes) {
                row.push(cell.trim());
                cell = "";
            } else if ((c === '\n' || c === '\r') && !inQuotes) {
                if (cell.length || row.length) {
                    row.push(cell.trim());
                    data.push(row);
                }
                row = [];
                cell = "";
                if (c === '\r' && next === '\n') i++;
            } else {
                cell += c;
            }
        }

        if (cell.length || row.length) {
            row.push(cell.trim());
            data.push(row);
        }

        headers = data.shift() || [];
        return data;
    }

    function renderTable(data) {
        thead.innerHTML = "";
        tbody.innerHTML = "";
        currentRows = data;

        downloadBtn.disabled = data.length === 0;

        var htr = document.createElement("tr");
        headers.forEach(function (h) {
            var th = document.createElement("th");
            th.textContent = h;
            htr.appendChild(th);
        });
        thead.appendChild(htr);

        data.forEach(function (row) {
            var tr = document.createElement("tr");
            row.forEach(function (cell) {
                var td = document.createElement("td");
                td.textContent = cell;
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });

        table.className = "";
    }

    function filterRows(query) {
        if (!query) {
            renderTable(rows);
            return;
        }

        var tokens = query.toLowerCase().split(/\s+/);
        var include = [];
        var exclude = [];

        tokens.forEach(function (t) {
            if (t.indexOf("--") === 0 && t.length > 2) {
                exclude.push(t.substring(2));
            } else {
                include.push(t);
            }
        });

        var filtered = rows.filter(function (row) {
            var text = row.join(" ").toLowerCase();

            for (var i = 0; i < include.length; i++) { if (text.indexOf(include[i]) === -1) return false; }
            for (var j = 0; j < exclude.length; j++) { if (text.indexOf(exclude[j]) !== -1) return false; }

            return true;
        });

        renderTable(filtered);
    }

    function escapeCSV(value) {
        if (value == null) return "";
        value = sanitizeText(String(value));

        if (/[",\n\r]/.test(value)) {
            return '"' + value.replace(/"/g, '""') + '"';
        }
        return value;
    }

    function buildCSV(headers, rows) {
        var out = [];
        out.push(headers.map(escapeCSV).join(","));
        rows.forEach(function (row) {
            out.push(row.map(escapeCSV).join(","));
        });
        return out.join("\r\n");
    }

    var file = getParam("file");

    if (file) {
        fileInput.className = "hidden";
        sourceFilename = file;

        fetch(BASE_URL + file)
            .then(function (res) {
                if (!res.ok) throw new Error();
                return res.text();
            })
            .then(function (text) {
                clearError();
                rows = parseCSV(text);
                renderTable(rows);
                searchInput.disabled = false;
            })
            .catch(function () {
                showError("Could not load CSV file: " + file);
            });
    }

    fileInput.addEventListener("change", function () {
        var file = this.files[0];
        if (!file) return;

        if (!file.name.toLowerCase().endsWith(".csv")) {
            showError("Please upload a .csv file.");
            return;
        }

        sourceFilename = file.name;

        var reader = new FileReader();
        reader.onload = function (e) {
            clearError();
            rows = parseCSV(e.target.result);
            renderTable(rows);
            searchInput.disabled = false;
            searchInput.value = "";
        };
        reader.onerror = function () {
            showError("Error reading file.");
        };
        reader.readAsText(file);
    });

    searchInput.addEventListener("input", function () {
        filterRows(this.value);
    });

    downloadBtn.addEventListener("click", function () {
        if (!currentRows.length) return;

        var csv = buildCSV(headers, currentRows);
        var blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        var url = URL.createObjectURL(blob);

        var base = sourceFilename.replace(/\.csv$/i, "");

        var a = document.createElement("a");
        a.href = url;
        a.download = base + "_filtered.csv";
        document.body.appendChild(a);
        a.click();

        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });
})();
</script>

</body>
</html>